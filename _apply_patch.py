from pathlib import Path
text = Path('app/routes.py').read_text(encoding='utf-8')
marker = '    if payment_status == "card_on_file" and setup_intent_id:'
start = text.index(marker)
end = text.index('    # Helpers', start)
old = text[start:end]
new = """    if payment_status == \"card_on_file\" and setup_intent_id:\n        try:\n            get_stripe_api_key()\n            kwargs = {\"stripe_account\": acct} if acct else {}\n            si = stripe.SetupIntent.retrieve(setup_intent_id, **kwargs)\n            customer_id = si.get(\"customer\")\n            pm_id = si.get(\"payment_method\")\n            if customer_id and pm_id:\n                try:\n                    attach_kwargs = {\"customer\": customer_id}\n                    if acct:\n                        attach_kwargs[\"stripe_account\"] = acct\n                    stripe.PaymentMethod.attach(pm_id, **attach_kwargs)\n                except stripe.error.InvalidRequestError:\n                    pass  # already attached is fine\n                try:\n                    modify_kwargs = {\"invoice_settings\": {\"default_payment_method\": pm_id}}\n                    if acct:\n                        stripe.Customer.modify(customer_id, stripe_account=acct, **modify_kwargs)\n                    else:\n                        stripe.Customer.modify(customer_id, **modify_kwargs)\n                    if client and hasattr(client, \"default_payment_method_id\"):\n                        client.default_payment_method_id = pm_id\n                    if client and hasattr(client, \"stripe_customer_id\") and not getattr(client, \"stripe_customer_id\", None):\n                        client.stripe_customer_id = customer_id\n                    db.session.commit()\n                except Exception:\n                    db.session.rollback()\n        except Exception as e:\n            current_app.logger.error(f\"[Batch Booking] Failed to set default PM from SetupIntent: {e}\")\n\n\n"""
Path('app/routes.py').write_text(text[:start] + new + text[end:], encoding='utf-8')
